@using sk.shared

<div class="position-relative" style="left: 50%; top: 50%;">
    <div class="skcard top-card @topCard?.GetCssClass() @clearAnimationCssClassTop">
    </div>
    <div class="skcard bottom-card @bottomCard?.GetCssClass() @clearAnimationCssClassBottom">
    </div>
    <div class="skcard left-card @leftCard?.GetCssClass() @clearAnimationCssClassLeft">
    </div>
    <div class="skcard right-card @rightCard?.GetCssClass() @clearAnimationCssClassRight">
    </div>
</div>
@if (!string.IsNullOrEmpty(cardAnimationCssClass))
{
    <div class="skcard @currentCard?.Card.GetCssClass() @cardAnimationCssClass">
    </div>
}

@code {
    protected override void OnInitialized()
    {
        base.OnInitialized();
    }

    Card? bottomCard;
    Card? leftCard;
    Card? topCard;
    Card? rightCard;
    PlayerCard? currentCard;
    string? clearAnimationCssClassBottom;
    string? clearAnimationCssClassLeft;
    string? clearAnimationCssClassTop;
    string? clearAnimationCssClassRight;

    private readonly Queue<PlayerCard> _cardAnimationQueue = new Queue<PlayerCard>();
    private bool _isProcessingQueue;


    string? cardAnimationCssClass => currentCard == null ? null : currentCard.Position switch {
        0 => "playbottomcard",
        1 => "playleftcard",
        2 => "playtopcard",
        3 => "playrightcard",
        _ => null
    };

    public void AddCard(PlayerCard playerCard)
    {
        _cardAnimationQueue.Enqueue(playerCard);
        if (!_isProcessingQueue)
        {
            _ = ProcessCardQueue();
        }
    }

    private async Task ProcessCardQueue()
    {
        _isProcessingQueue = true;

        while (_cardAnimationQueue.Any())
        {
            var playerCard = _cardAnimationQueue.Dequeue();

            // Set currentCard for animation
            currentCard = playerCard;
            await InvokeAsync(StateHasChanged);

            // Wait for animation to complete
            await Task.Delay(800);

            // Move card to static position and clear animated card
            await InvokeAsync(() =>
            {
                _ = playerCard.Position switch {
                    0 => bottomCard = playerCard.Card,
                    1 => leftCard = playerCard.Card,
                    2 => topCard = playerCard.Card,
                    3 => rightCard = playerCard.Card,
                    _ => null,
                };
                currentCard = null;
                StateHasChanged();
            });
        }

        _isProcessingQueue = false;
    }


    public async void Clear(int position)
    {
        if (bottomCard != null) clearAnimationCssClassBottom = $"clear-to-pos{position}-from-bottom";
        if (leftCard != null) clearAnimationCssClassLeft = $"clear-to-pos{position}-from-left";
        if (topCard != null) clearAnimationCssClassTop = $"clear-to-pos{position}-from-top";
        if (rightCard != null) clearAnimationCssClassRight = $"clear-to-pos{position}-from-right";

        await InvokeAsync(StateHasChanged);

        await Task.Delay(800); // Animation duration, should match CSS

        await InvokeAsync(() =>
        {
            bottomCard = null;
            leftCard = null;
            topCard = null;
            rightCard = null;
            currentCard = null; // Ensure current card is also cleared

            clearAnimationCssClassBottom = null;
            clearAnimationCssClassLeft = null;
            clearAnimationCssClassTop = null;
            clearAnimationCssClassRight = null;

            StateHasChanged();
        });
    }}